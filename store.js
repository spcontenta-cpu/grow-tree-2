import { create } from "zustand";
export const useApp = create((set,get)=>({ user:null, dayIndex:1, plantStage:0, streak:0, checklist:{ meals:{breakfast:false,lunch:false,dinner:false,snacks:false}, waterMl:0, steps:0, workout:{warmup:false,main:false,cooldown:false}, study:{ai1:false,ai2:false,aws1:false,aws2:false} }, journal:'', photoDataUrl:'', foods:[], targets:{protein:150, carbs:190, fat:58, kcal:1850, waterMl:3500, steps:10000, micros:{}}, login:(u)=>set({user:{id:'local',name:u}}), logout:()=>set({user:null}), addWater:(ml)=>set(s=>({checklist:{...s.checklist, waterMl: Math.max(0, s.checklist.waterMl + ml)}})), setSteps:(steps)=>set(s=>({checklist:{...s.checklist, steps: Math.max(0, steps|0)}})), toggleCheck:(path)=>set(s=>{const next=JSON.parse(JSON.stringify(s.checklist)); const segs=path.split('.'); let cur=next; for(let i=0;i<segs.length-1;i++) cur=cur[segs[i]]; cur[segs[segs.length-1]] = !cur[segs[segs.length-1]]; return {checklist:next};}), addFood:(foodKey,grams)=>set(s=>({foods:[...s.foods,{id:crypto.randomUUID(),foodKey,grams:Number(grams)||0}]})), removeFood:(id)=>set(s=>({foods:s.foods.filter(f=>f.id!==id)})), setJournal:(txt)=>set({journal:txt}), setPhoto:(d)=>set({photoDataUrl:d}), totals:()=>{const foods=get().foods; const FOODS={"chicken_breast_cooked":{protein:31,carbs:0,fat:3.6,kcal:165},"egg_boiled":{protein:13,carbs:1,fat:11,kcal:155},"walnuts":{protein:15,carbs:14,fat:65,kcal:654},"cashews":{protein:18,carbs:30,fat:44,kcal:553},"almonds":{protein:21,carbs:22,fat:50,kcal:579},"dates":{protein:2,carbs:75,fat:0.5,kcal:282},"raisins":{protein:3,carbs:79,fat:0.5,kcal:299},"chana_boiled":{protein:9,carbs:27,fat:3,kcal:164},"peanuts_roasted":{protein:25,carbs:16,fat:49,kcal:585}}; let protein=0,carbs=0,fat=0,kcal=0; for(const f of foods){const info=FOODS[f.foodKey]; if(!info) continue; const factor=(f.grams||0)/100; protein+=info.protein*factor; carbs+=info.carbs*factor; fat+=info.fat*factor; kcal+=info.kcal*factor;} return {protein,carbs,fat,kcal}; }, resetDaily:()=>set({checklist:{meals:{breakfast:false,lunch:false,dinner:false,snacks:false},waterMl:0,steps:0,workout:{warmup:false,main:false,cooldown:false},study:{ai1:false,ai2:false,aws1:false,aws2:false}}, journal:'',photoDataUrl:'',foods:[]}), nextDay:()=>set(s=>{const allMeals=Object.values(s.checklist.meals).every(Boolean); const waterOk=s.checklist.waterMl>=s.targets.waterMl; const stepsOk=s.checklist.steps>=s.targets.steps; const workoutOk=Object.values(s.checklist.workout).every(Boolean); const studyOk=Object.values(s.checklist.study).every(Boolean); const allDone=allMeals && waterOk && stepsOk && workoutOk && studyOk; let plantStage=s.plantStage; let streak=s.streak; if(allDone){streak+=1; plantStage=Math.min(5, plantStage+1);} else {streak=0; plantStage=0;} return {dayIndex: s.dayIndex+1, plantStage, streak, checklist:{meals:{breakfast:false,lunch:false,dinner:false,snacks:false},waterMl:0,steps:0,workout:{warmup:false,main:false,cooldown:false},study:{ai1:false,ai2:false,aws1:false,aws2:false}}, journal:'',photoDataUrl:'',foods:[]}}), load:()=>{try{const raw=localStorage.getItem('gyt_state_v3'); if(!raw) return; const data=JSON.parse(raw); set(data);}catch{}}, save:()=>set(s=>{localStorage.setItem('gyt_state_v3',JSON.stringify(s)); return {}; }), setTargets:(t)=>set(s=>({targets:{...s.targets,...t}})) }));